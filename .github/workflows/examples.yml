name: test examples

on:
  push:
    branches:
      - master
      - develop
  pull_request:
    branches:
      - master
      - develop

jobs:
  examples:
    name: ${{ matrix.examples }} example
    runs-on: ${{ matrix.os }}
    if: "!contains(github.event.head_commit.message, 'nogha')"

    strategy:
      matrix:
        version: [10, 11, 12, 13]
        os: ["ubuntu-latest"]
        examples: ["arrays", "bad_ideas", "bgworker", "bytea", "custom_types", "errors", "operators", "schemas", "shmem", "spi", "srf", "strings"]

    steps:
    - uses: actions/checkout@v2

    - name: cargo version
      run: cargo --version

    # Ubuntu system dependencies required to build Postgres from sources
    - name: install postgres build dependencies
      run: sudo apt install -y bison flex zlib1g zlib1g-dev pkg-config libssl-dev libreadline-dev

    # install cargo-pgx
    - name: install cargo-pgx
      run: cargo install --path cargo-pgx/ --debug

    # initialize pgx for this PG version
    - name: cargo pgx init
      run: cargo pgx init --pg${{ matrix.version }}=download

    - name: create new sample extension
      run: cd /tmp/ && cargo pgx new sample

      # make sure the examples build too and build them in the matrix
    - name: ${{ matrix.examples }} example on pg${{ matrix.version }}
      run: cd pgx-examples/${{ matrix.examples }} && cargo pgx test pg${{ matrix.version }}
